<script>
// ========== CONFIGURA√á√ÉO SUPABASE ==========
const SUPABASE_URL = 'https://syztbxvpdaplpetmixmt.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN5enRieHZwZGFwbHBldG1peG10Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQxODY0OTAsImV4cCI6MjA3OTc2MjQ5MH0.SISlMoO1kLWbIgx9pze8Dv1O-kfQ_TAFDX6yPUxfJxo';

console.log('üöÄ Weber Lessa Im√≥veis - Sistema Iniciado');

// ========== SISTEMA DE IM√ìVEIS ==========
let properties = [];
let editingPropertyId = null;
let selectedFiles = [];

// Dados iniciais
function getInitialProperties() {
    return [
        {
            id: 1,
            title: "Apartamento Vista Mar - Ponta Verde",
            price: "R$ 450.000",
            location: "Ponta Verde, Macei√≥-AL",
            description: "Excelente apartamento com vista panor√¢mica para o mar, localizado no bairro mais valorizado de Macei√≥.",
            features: ["2 Quartos", "1 Vaga", "Condom√≠nio Fechado", "Piscina", "Varanda"],
            type: "residencial",
            has_video: true,
            badge: "Destaque",
            rural: false,
            images: "",
            created_at: new Date().toISOString()
        },
        {
            id: 2,
            title: "Fazenda - 300 Tarefas",
            price: "R$ 1.200.000",
            location: "Zona Rural - 90km de Macei√≥-AL",
            description: "Excelente fazenda de 300 tarefas com casa sede, cercada com piquetes para gado, baia/curral, v√°rias nascentes.",
            features: ["300 Tarefas", "Casa Sede", "V√°rias Nascentes", "Baia/Curral", "Piquetes"],
            type: "rural",
            has_video: true,
            badge: "Fazenda",
            rural: true,
            images: "",
            created_at: new Date().toISOString()
        }
    ];
}

// ========== FUN√á√ïES DO PAINEL ADMIN ==========
const ADMIN_PASSWORD = "weber123";

function toggleAdminPanel() {
    const password = prompt("Digite a senha de acesso ao painel:");
    if (password === ADMIN_PASSWORD) {
        const panel = document.getElementById('adminPanel');
        if (panel) {
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
            if (panel.style.display === 'block') {
                loadPropertyList();
            }
        } else {
            createAdminPanel();
        }
    } else {
        alert("Senha incorreta!");
    }
}

function createAdminPanel() {
    const adminHTML = `
        <h3 style="text-align: center; color: var(--primary); margin-bottom: 1.5rem;">
            <i class="fas fa-cog"></i> Painel do Corretor - Weber Lessa
        </h3>
        
        <div style="background: white; padding: 2rem; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
            <h4 style="color: var(--primary); margin-bottom: 1.5rem;">
                <i class="fas fa-home"></i> Adicionar/Editar Im√≥vel
            </h4>
            
            <form id="propertyForm">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                    <div>
                        <label><strong>T√≠tulo do Im√≥vel *</strong></label>
                        <input type="text" id="propTitle" placeholder="Ex: Apartamento Vista Mar" required style="padding: 0.8rem; border: 1px solid #ddd; border-radius: 5px; width: 100%;">
                    </div>
                    <div>
                        <label><strong>Pre√ßo *</strong></label>
                        <input type="text" id="propPrice" placeholder="Ex: R$ 450.000" required style="padding: 0.8rem; border: 1px solid #ddd; border-radius: 5px; width: 100%;">
                    </div>
                </div>
                
                <div style="margin-bottom: 1rem;">
                    <label><strong>Localiza√ß√£o *</strong></label>
                    <input type="text" id="propLocation" placeholder="Ex: Ponta Verde, Macei√≥-AL" required style="padding: 0.8rem; border: 1px solid #ddd; border-radius: 5px; width: 100%;">
                </div>
                
                <div style="margin-bottom: 1rem;">
                    <label><strong>Descri√ß√£o</strong></label>
                    <textarea id="propDescription" placeholder="Descreva o im√≥vel..." style="padding: 0.8rem; border: 1px solid #ddd; border-radius: 5px; width: 100%; height: 100px;"></textarea>
                </div>
                
                <div style="margin-bottom: 1rem;">
                    <label><strong>Caracter√≠sticas</strong></label>
                    <input type="text" id="propFeatures" placeholder="Ex: 2 Quartos, 1 Vaga, Piscina, Varanda" style="padding: 0.8rem; border: 1px solid #ddd; border-radius: 5px; width: 100%;">
                    <small style="color: #666;">Separe por v√≠rgulas</small>
                </div>
                
                <!-- ========== SE√á√ÉO DE UPLOAD ========== -->
                <div style="margin-bottom: 1.5rem;">
                    <label><strong>Fotos, V√≠deos e Documentos</strong></label>
                    
                    <div id="uploadArea" class="upload-area">
                        <i class="fas fa-cloud-upload-alt" style="font-size: 2.5rem; color: #ccc; margin-bottom: 1rem;"></i>
                        <p style="margin: 0.5rem 0; font-size: 1.1rem; color: #555;">Clique ou arraste arquivos aqui</p>
                        <p style="margin: 0; font-size: 0.9rem; color: #888;">
                            <i class="fas fa-image"></i> Fotos (JPG, PNG) ‚Ä¢ 
                            <i class="fas fa-video"></i> V√≠deos (MP4) ‚Ä¢ 
                            <i class="fas fa-file-pdf"></i> PDFs
                        </p>
                        <p style="margin: 0.5rem 0 0; font-size: 0.8rem; color: #999;">M√°ximo: 10 arquivos ‚Ä¢ 5MB cada</p>
                    </div>
                    
                    <input type="file" id="fileInput" multiple accept="image/*,video/*,.pdf" style="display: none;">
                    
                    <div id="uploadPreview" class="file-preview"></div>
                    
                    <div id="progressBar" class="progress-bar">
                        <div id="progressFill" class="progress-fill"></div>
                    </div>
                </div>
                <!-- ========== FIM DA SE√á√ÉO DE UPLOAD ========== -->
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                    <div>
                        <label><strong>Tipo do Im√≥vel</strong></label>
                        <select id="propType" style="padding: 0.8rem; border: 1px solid #ddd; border-radius: 5px; width: 100%;">
                            <option value="residencial">Residencial</option>
                            <option value="comercial">Comercial</option>
                            <option value="rural">Rural</option>
                        </select>
                    </div>
                    <div>
                        <label><strong>Destaque</strong></label>
                        <select id="propBadge" style="padding: 0.8rem; border: 1px solid #ddd; border-radius: 5px; width: 100%;">
                            <option value="Novo">Novo</option>
                            <option value="Destaque">Destaque</option>
                            <option value="Luxo">Luxo</option>
                            <option value="MCMV">Minha Casa Minha Vida</option>
                            <option value="Fazenda">Fazenda</option>
                            <option value="Ch√°cara">Ch√°cara</option>
                        </select>
                    </div>
                </div>
                
                <div style="margin-bottom: 1.5rem;">
                    <label style="display: flex; align-items: center; gap: 0.5rem;">
                        <input type="checkbox" id="propHasVideo"> 
                        <span><strong>Este im√≥vel tem v√≠deo?</strong></span>
                    </label>
                </div>
                
                <div style="display: flex; gap: 1rem;">
                    <button type="submit" style="background: var(--success); color: white; padding: 1rem 2rem; border: none; border-radius: 5px; cursor: pointer; flex: 1; font-size: 1.1rem;">
                        <i class="fas fa-save"></i> Salvar Im√≥vel
                    </button>
                    <button type="button" id="cancelEditBtn" onclick="cancelEdit()" style="background: #95a5a6; color: white; padding: 1rem 2rem; border: none; border-radius: 5px; cursor: pointer; display: none;">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                </div>
            </form>
        </div>
        
        <div style="margin-top: 3rem; padding-top: 2rem; border-top: 1px solid #eee;">
            <h4>Gerenciar Im√≥veis Existentes</h4>
            <p><small>Total de im√≥veis: <span id="propertyCount">${properties.length}</span></small></p>
            <div id="propertyList"></div>
        </div>
    `;
    
    document.getElementById('adminPanel').innerHTML = adminHTML;
    setupForm();
    setupUploadSystem();
    loadPropertyList();
}

function loadPropertyList() {
    const container = document.getElementById('propertyList');
    const countElement = document.getElementById('propertyCount');
    
    if (!container) return;
    
    container.innerHTML = '';
    if (countElement) countElement.textContent = properties.length;
    
    if (properties.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #666; padding: 2rem;">Nenhum im√≥vel cadastrado.</p>';
        return;
    }
    
    properties.forEach(property => {
        const features = Array.isArray(property.features) 
            ? property.features 
            : (property.features ? property.features.split(',') : []);
            
        const item = document.createElement('div');
        item.className = 'property-item';
        item.innerHTML = `
            <div style="flex: 1;">
                <strong style="color: var(--primary);">${property.title}</strong><br>
                <small>${property.price} - ${property.location}</small>
                <div style="margin-top: 0.5rem;">
                    ${features.map(f => 
                        `<span style="background: var(--accent); color: white; padding: 0.2rem 0.5rem; border-radius: 10px; font-size: 0.8rem; margin-right: 0.3rem; display: inline-block; margin-bottom: 0.3rem;">${f.trim()}</span>`
                    ).join('')}
                </div>
                ${property.images ? `<div style="margin-top: 0.5rem; font-size: 0.8rem; color: #666;">üì∑ ${property.images.split(',').length} arquivo(s)</div>` : ''}
            </div>
            <div style="display: flex; gap: 0.5rem;">
                <button onclick="editProperty(${property.id})" style="background: var(--accent); color: white; border: none; padding: 0.5rem 1rem; border-radius: 3px; cursor: pointer; display: flex; align-items: center; gap: 0.3rem;">
                    <i class="fas fa-edit"></i> Editar
                </button>
                <button onclick="deleteProperty(${property.id})" style="background: #e74c3c; color: white; border: none; padding: 0.5rem 1rem; border-radius: 3px; cursor: pointer; display: flex; align-items: center; gap: 0.3rem;">
                    <i class="fas fa-trash"></i> Excluir
                </button>
            </div>
        `;
        container.appendChild(item);
    });
}

function deleteProperty(id) {
    const property = properties.find(p => p.id === id);
    if (!property) return;

    if (confirm(`Tem certeza que deseja EXCLUIR permanentemente o im√≥vel:\n\n"${property.title}"?\n\nEsta a√ß√£o n√£o pode ser desfeita.`)) {
        const index = properties.findIndex(p => p.id === id);
        if (index !== -1) {
            properties.splice(index, 1);
            localStorage.setItem('weberlessa_properties', JSON.stringify(properties));
        }
        
        renderProperties();
        loadPropertyList();
        alert("‚úÖ Im√≥vel exclu√≠do com sucesso!");
    }
}

// ========== SISTEMA DE EDI√á√ÉO ==========
function editProperty(id) {
    const property = properties.find(p => p.id === id);
    if (!property) return;

    editingPropertyId = id;
    
    document.getElementById('propTitle').value = property.title || '';
    document.getElementById('propPrice').value = property.price || '';
    document.getElementById('propLocation').value = property.location || '';
    document.getElementById('propDescription').value = property.description || '';
    
    const features = Array.isArray(property.features) 
        ? property.features 
        : (property.features || '');
    document.getElementById('propFeatures').value = Array.isArray(features) ? features.join(', ') : features;
    
    document.getElementById('propType').value = property.type || 'residencial';
    document.getElementById('propBadge').value = property.badge || 'Novo';
    document.getElementById('propHasVideo').checked = property.has_video || false;
    
    selectedFiles = [];
    showPreview();
    
    const submitBtn = document.querySelector('#propertyForm button[type="submit"]');
    if (submitBtn) {
        submitBtn.innerHTML = '<i class="fas fa-save"></i> Atualizar Im√≥vel';
    }
    
    const cancelBtn = document.getElementById('cancelEditBtn');
    if (cancelBtn) {
        cancelBtn.style.display = 'block';
    }
    
    alert("Im√≥vel carregado para edi√ß√£o! Modifique os campos e clique em 'Atualizar Im√≥vel'.");
}

function cancelEdit() {
    editingPropertyId = null;
    const form = document.getElementById('propertyForm');
    if (form) form.reset();
    
    const submitBtn = document.querySelector('#propertyForm button[type="submit"]');
    if (submitBtn) {
        submitBtn.innerHTML = '<i class="fas fa-save"></i> Salvar Im√≥vel';
    }
    
    const cancelBtn = document.getElementById('cancelEditBtn');
    if (cancelBtn) {
        cancelBtn.style.display = 'none';
    }
    
    selectedFiles = [];
    showPreview();
}

// ========== CARREGAR IM√ìVEIS ==========
async function loadProperties() {
    try {
        console.log('üì° Carregando im√≥veis...');
        
        const response = await fetch(`${SUPABASE_URL}/rest/v1/properties?select=*`, {
            headers: {
                'apikey': SUPABASE_KEY,
                'Authorization': `Bearer ${SUPABASE_KEY}`
            }
        });
        
        if (response.ok) {
            const data = await response.json();
            properties = Array.isArray(data) ? data : [];
            console.log(`‚úÖ ${properties.length} im√≥veis carregados do Supabase`);
        } else {
            console.log('‚ö†Ô∏è Supabase n√£o acess√≠vel, usando dados locais');
            throw new Error('Supabase n√£o dispon√≠vel');
        }
        
    } catch (error) {
        console.log('üîÑ Usando dados locais');
        const localData = localStorage.getItem('weberlessa_properties');
        properties = localData ? JSON.parse(localData) : getInitialProperties();
    }
    
    renderProperties();
}

// ========== SALVAR IM√ìVEL ==========
async function saveProperty(propertyData) {
    try {
        console.log('üíæ Iniciando salvamento...');
        
        let fileUrls = [];
        if (selectedFiles.length > 0) {
            console.log('üì§ Tentando upload de', selectedFiles.length, 'arquivos...');
            fileUrls = await uploadFiles();
            console.log('‚úÖ Upload conclu√≠do:', fileUrls);
        }
        
        const dataToSave = {
            title: propertyData.title,
            price: propertyData.price,
            location: propertyData.location,
            description: propertyData.description,
            features: propertyData.features.join(', '),
            type: propertyData.type,
            has_video: propertyData.has_video,
            badge: propertyData.badge,
            rural: propertyData.rural,
            images: fileUrls.length > 0 ? fileUrls.join(',') : '',
            created_at: new Date().toISOString()
        };

        let url, method;
        if (editingPropertyId) {
            url = `${SUPABASE_URL}/rest/v1/properties?id=eq.${editingPropertyId}`;
            method = 'PATCH';
        } else {
            url = `${SUPABASE_URL}/rest/v1/properties`;
            method = 'POST';
        }

        console.log('üì§ Enviando dados para:', url);
        const response = await fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json',
                'apikey': SUPABASE_KEY,
                'Authorization': `Bearer ${SUPABASE_KEY}`,
                'Prefer': 'return=representation'
            },
            body: JSON.stringify(dataToSave)
        });

        if (response.ok) {
            const result = await response.json();
            console.log('‚úÖ Im√≥vel salvo com sucesso no Supabase!', result);
            await loadProperties();
            return true;
        } else {
            const errorText = await response.text();
            console.error('‚ùå Erro Supabase:', errorText);
            throw new Error(`Supabase: ${response.status} - ${errorText}`);
        }

    } catch (error) {
        console.log('‚ö†Ô∏è Salvando localmente:', error.message);
        
        const fallbackData = {
            ...propertyData,
            id: editingPropertyId || (properties.length > 0 ? Math.max(...properties.map(p => p.id)) + 1 : 1),
            images: selectedFiles.length > 0 ? 'local_files' : '',
            created_at: new Date().toISOString()
        };

        if (editingPropertyId) {
            const index = properties.findIndex(p => p.id === editingPropertyId);
            if (index !== -1) {
                properties[index] = fallbackData;
            }
        } else {
            properties.push(fallbackData);
        }
        
        localStorage.setItem('weberlessa_properties', JSON.stringify(properties));
        renderProperties();
        
        return false;
    }
}

// ========== FORMUL√ÅRIO ==========
function setupForm() {
    const form = document.getElementById('propertyForm');
    if (!form) return;

    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const propertyData = {
            title: document.getElementById('propTitle').value,
            price: document.getElementById('propPrice').value,
            location: document.getElementById('propLocation').value,
            description: document.getElementById('propDescription').value,
            features: document.getElementById('propFeatures').value.split(',').map(f => f.trim()).filter(f => f !== ''),
            type: document.getElementById('propType').value,
            has_video: document.getElementById('propHasVideo').checked,
            badge: document.getElementById('propBadge').value,
            rural: document.getElementById('propType').value === 'rural'
        };

        if (!propertyData.title || !propertyData.price || !propertyData.location) {
            alert('‚ùå Preencha T√≠tulo, Pre√ßo e Localiza√ß√£o!');
            return;
        }

        const submitBtn = document.querySelector('#propertyForm button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Salvando...';
        submitBtn.disabled = true;

        try {
            const success = await saveProperty(propertyData);
            
            if (success) {
                alert("‚úÖ Im√≥vel salvo com sucesso no banco de dados!");
            } else {
                alert("‚úÖ Im√≥vel salvo localmente!");
            }

            this.reset();
            cancelEdit();
            selectedFiles = [];
            showPreview();

        } catch (error) {
            alert("‚ùå Erro: " + error.message);
        } finally {
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        }
    });
}

// ========== RENDERIZAR IM√ìVEIS ==========
function renderProperties(filter = 'todos') {
    const container = document.getElementById('properties-container');
    if (!container) return;
    
    container.innerHTML = '';
    
    const filteredProperties = filter === 'todos' ? properties : properties.filter(p => {
        if (filter === 'residencial') return p.type === 'residencial';
        if (filter === 'comercial') return p.type === 'comercial';
        if (filter === 'rural') return p.type === 'rural';
        if (filter === 'mcmv') return p.badge === 'MCMV';
        return true;
    });
    
    if (filteredProperties.length === 0) {
        container.innerHTML = '<p style="text-align: center; padding: 2rem; color: #666;">Nenhum im√≥vel encontrado.</p>';
        return;
    }
    
    filteredProperties.forEach(property => {
        const features = Array.isArray(property.features) ? property.features : (property.features ? property.features.split(',') : []);
        const imageUrls = property.images ? property.images.split(',') : [];
        const firstImage = imageUrls.length > 0 ? imageUrls[0] : null;
        
        const card = `
            <div class="property-card">
                <div class="property-image ${property.rural ? 'rural-image' : ''}">
                    ${firstImage && firstImage !== 'local_files' ? 
                        `<img src="${firstImage}" alt="${property.title}" onerror="this.style.display='none'">` : 
                        (property.rural ? 'üå≥' : 'üè†') + ' ' + property.title.split(' - ')[0]
                    }
                    ${property.badge ? `<div class="property-badge ${property.rural ? 'rural-badge' : ''}">${property.badge}</div>` : ''}
                    ${property.has_video ? `<div class="video-indicator"><i class="fas fa-video"></i> TEM V√çDEO</div>` : ''}
                    ${imageUrls.length > 1 && imageUrls[0] !== 'local_files' ? `<div style="position: absolute; bottom: 10px; right: 10px; background: rgba(0,0,0,0.7); color: white; padding: 0.3rem 0.6rem; border-radius: 15px; font-size: 0.8rem;">üì∑ ${imageUrls.length}</div>` : ''}
                </div>
                <div class="property-content">
                    <div class="property-price">${property.price}</div>
                    <h3 class="property-title">${property.title}</h3>
                    <div class="property-location"><i class="fas fa-map-marker-alt"></i> ${property.location}</div>
                    <p>${property.description}</p>
                    <div class="property-features">
                        ${features.map(f => `<span class="feature-tag ${property.rural ? 'rural-tag' : ''}">${f.trim()}</span>`).join('')}
                    </div>
                    <button class="contact-btn" onclick="contactAgent(${property.id})">
                        <i class="fab fa-whatsapp"></i> Entrar em Contato
                    </button>
                </div>
            </div>
        `;
        container.innerHTML += card;
    });
}

// ========== SISTEMA DE UPLOAD ==========
function setupUploadSystem() {
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');
    const uploadPreview = document.getElementById('uploadPreview');

    if (uploadArea && fileInput) {
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            
            if (e.dataTransfer.files.length > 0) {
                handleFiles(e.dataTransfer.files);
            }
        });
        
        uploadArea.addEventListener('click', () => fileInput.click());
        
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFiles(e.target.files);
            }
        });
    }
}

function handleFiles(files) {
    const newFiles = Array.from(files);
    
    if (selectedFiles.length + newFiles.length > 10) {
        alert('‚ö†Ô∏è M√°ximo de 10 arquivos permitidos!');
        return;
    }
    
    for (const file of newFiles) {
        if (file.size > 5 * 1024 * 1024) {
            alert(`‚ö†Ô∏è O arquivo "${file.name}" √© muito grande! M√°ximo: 5MB`);
            return;
        }
    }
    
    selectedFiles = [...selectedFiles, ...newFiles];
    showPreview();
}

function showPreview() {
    const preview = document.getElementById('uploadPreview');
    if (!preview) return;
    
    preview.innerHTML = '';
    
    if (selectedFiles.length === 0) {
        preview.innerHTML = `
            <div style="width: 100%; text-align: center; padding: 1rem; color: #999;">
                <i class="fas fa-images" style="font-size: 2rem; margin-bottom: 0.5rem;"></i>
                <p>Nenhum arquivo selecionado</p>
            </div>
        `;
        return;
    }
    
    selectedFiles.forEach((file, index) => {
        const fileItem = document.createElement('div');
        fileItem.className = 'file-item';
        
        if (file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = (e) => {
                fileItem.innerHTML = `
                    <img src="${e.target.result}" alt="${file.name}">
                    <div class="file-info">
                        <i class="fas fa-image"></i> ${file.name.substring(0, 10)}...
                    </div>
                    <button class="remove-file" onclick="removeFile(${index})">√ó</button>
                `;
                preview.appendChild(fileItem);
            };
            reader.readAsDataURL(file);
            
        } else if (file.type.startsWith('video/')) {
            fileItem.innerHTML = `
                <div style="width: 100px; height: 100px; background: linear-gradient(135deg, #667eea, #764ba2); display: flex; flex-direction: column; justify-content: center; align-items: center; color: white;">
                    <i class="fas fa-video" style="font-size: 2rem; margin-bottom: 0.5rem;"></i>
                    <div style="font-size: 0.7rem; text-align: center; padding: 0 0.3rem;">
                        ${file.name.substring(0, 12)}...
                    </div>
                </div>
                <button class="remove-file" onclick="removeFile(${index})">√ó</button>
            `;
            preview.appendChild(fileItem);
            
        } else if (file.type === 'application/pdf') {
            fileItem.innerHTML = `
                <div style="width: 100px; height: 100px; background: linear-gradient(135deg, #e74c3c, #c0392b); display: flex; flex-direction: column; justify-content: center; align-items: center; color: white;">
                    <i class="fas fa-file-pdf" style="font-size: 2rem; margin-bottom: 0.5rem;"></i>
                    <div style="font-size: 0.7rem; text-align: center; padding: 0 0.3rem;">
                        ${file.name.substring(0, 12)}...
                    </div>
                </div>
                <button class="remove-file" onclick="removeFile(${index})">√ó</button>
            `;
            preview.appendChild(fileItem);
        }
    });
}

function removeFile(index) {
    selectedFiles.splice(index, 1);
    showPreview();
    
    const dataTransfer = new DataTransfer();
    selectedFiles.forEach(file => dataTransfer.items.add(file));
    document.getElementById('fileInput').files = dataTransfer.files;
}

async function uploadFiles() {
    if (selectedFiles.length === 0) return [];
    
    const progressBar = document.getElementById('progressBar');
    const progressFill = document.getElementById('progressFill');
    
    progressBar.style.display = 'block';
    progressFill.style.width = '0%';
    
    const uploadedUrls = [];
    
    for (let i = 0; i < selectedFiles.length; i++) {
        const file = selectedFiles[i];
        
        try {
            progressFill.style.width = `${((i + 1) / selectedFiles.length) * 100}%`;
            
            const fileUrl = await uploadFileToSupabase(file);
            if (fileUrl) {
                uploadedUrls.push(fileUrl);
                console.log(`‚úÖ Arquivo ${i + 1}/${selectedFiles.length} enviado:`, fileUrl);
            } else {
                console.log(`‚ö†Ô∏è Upload falhou para: ${file.name}`);
            }
        } catch (error) {
            console.error('‚ùå Erro ao enviar arquivo:', error);
        }
    }
    
    setTimeout(() => {
        progressBar.style.display = 'none';
    }, 1000);
    
    return uploadedUrls;
}

async function uploadFileToSupabase(file) {
    try {
        // Verificar se o bucket existe e est√° acess√≠vel
        const bucketCheck = await fetch(`${SUPABASE_URL}/storage/v1/bucket/properties`, {
            headers: {
                'Authorization': `Bearer ${SUPABASE_KEY}`,
                'apikey': SUPABASE_KEY
            }
        });

        if (!bucketCheck.ok) {
            console.log('‚ùå Bucket "properties" n√£o encontrado. Criando...');
            // Se o bucket n√£o existir, vamos usar fallback para localStorage
            return null;
        }

        const fileName = `property_${Date.now()}_${file.name.replace(/\s+/g, '_')}`;
        const formData = new FormData();
        formData.append('file', file);
        
        const response = await fetch(`${SUPABASE_URL}/storage/v1/object/properties/${fileName}`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${SUPABASE_KEY}`,
                'apikey': SUPABASE_KEY
            },
            body: formData
        });
        
        if (response.ok) {
            const result = await response.json();
            const publicUrl = `${SUPABASE_URL}/storage/v1/object/public/properties/${fileName}`;
            console.log('‚úÖ Upload bem-sucedido:', publicUrl);
            return publicUrl;
        } else {
            const errorText = await response.text();
            console.error('‚ùå Erro no upload:', response.status, errorText);
            return null;
        }
        
    } catch (error) {
        console.error('‚ùå Erro no upload:', error);
        return null;
    }
}

// ========== FUN√á√ïES DE INTERA√á√ÉO ==========
function contactAgent(id) {
    const property = properties.find(p => p.id === id);
    if (property) {
        const message = `Ol√°! Tenho interesse no im√≥vel: ${property.title} - ${property.price}`;
        const whatsappURL = `https://wa.me/5582996044513?text=${encodeURIComponent(message)}`;
        window.open(whatsappURL, '_blank');
    }
}

// ========== INICIALIZA√á√ÉO ==========
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Sistema Weber Lessa Iniciado');
    loadProperties();
    
    const filterButtons = document.querySelectorAll('.filter-btn');
    filterButtons.forEach(button => {
        button.addEventListener('click', function() {
            filterButtons.forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');
            let filter = 'todos';
            const text = this.textContent.trim();
            if (text === 'Residencial') filter = 'residencial';
            else if (text === 'Comercial') filter = 'comercial';
            else if (text === 'Rural') filter = 'rural';
            else if (text === 'Minha Casa Minha Vida') filter = 'mcmv';
            renderProperties(filter);
        });
    });
});
</script>
