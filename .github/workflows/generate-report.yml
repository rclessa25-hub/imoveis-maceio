name: ðŸš€ Gerar RelatÃ³rio do Projeto

on:
  push:
    branches: [ main, master ]
  schedule:
    - cron: '0 0 * * 0'  # Executa todo domingo Ã  meia-noite
  workflow_dispatch:      # Permite execuÃ§Ã£o manual

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  generate-report:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout do repositÃ³rio
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ðŸ Configurar Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: ðŸ“¦ Instalar dependÃªncias
      run: |
        pip install markdown Pygments
        sudo apt-get update
        sudo apt-get install -y tree

    - name: ðŸ“ Criar script de geraÃ§Ã£o
      run: |
        cat > generate_report.py << 'EOF'
        #!/usr/bin/env python3
        import os
        import json
        import markdown
        from datetime import datetime
        
        # Ler configuraÃ§Ã£o
        with open('report-config.json', 'r') as f:
            config = json.load(f)
        
        # Obter estrutura do projeto
        def get_structure():
            import subprocess
            try:
                result = subprocess.run(['tree', '-a', '--charset=utf-8'], 
                                      capture_output=True, text=True)
                return result.stdout if result.returncode == 0 else "Estrutura nÃ£o disponÃ­vel"
            except:
                return "Instale 'tree' para ver a estrutura completa"
        
        # Gerar relatÃ³rio Markdown
 # Substitua a funÃ§Ã£o generate_markdown() por esta:

        def generate_markdown():
            content = []
            content.append(f"# ðŸ“‹ RelatÃ³rio do Projeto: {config['project_name']}")
            content.append(f"**Arquitetura:** {config['architecture']['type']}")
            content.append(f"**Gerado em:** {datetime.now().strftime('%d/%m/%Y %H:%M:%S')}")
            content.append(f"**VersÃ£o:** {config.get('version', '2.0.0')}")
            content.append("")
            
            # VisÃ£o Geral
            content.append("## ðŸŽ¯ VisÃ£o Geral")
            content.append(config['project_description'])
            content.append("")
            
            # Arquitetura
            content.append("## ðŸ—ï¸ Arquitetura do Sistema")
            content.append(f"**Tipo:** {config['architecture']['type']}")
            content.append(f"**Framework Frontend:** {config['architecture']['frontend_framework']}")
            content.append(f"**Arquitetura CSS:** {config['architecture']['css_architecture']}")
            content.append(f"**Gerenciamento de Estado:** {config['architecture']['state_management']}")
            content.append("")
            
            # Links
            content.append("## ðŸ”— Links Importantes")
            for name, url in config['external_links'].items():
                content.append(f"- **{name.replace('_', ' ').title()}:** [{url}]({url})")
            content.append("")
            
            # Estrutura Modular
            content.append("## ðŸ“ Estrutura Modular")
            content.append("```")
            content.append(get_structure())
            content.append("```")
            content.append("")
            
            # MÃ³dulos
            content.append("## ðŸ§© MÃ³dulos do Sistema")
            for category, items in config['architecture']['structure'].items():
                if items:
                    content.append(f"### {category.title()}")
                    for item in items:
                        content.append(f"- {item}")
                    content.append("")
            
            # Features
            content.append("## âœ¨ Funcionalidades da Arquitetura")
            for feature, enabled in config['features'].items():
                if enabled:
                    content.append(f"- âœ… {feature.replace('_', ' ').title()}")
            content.append("")
            
            # Tecnologias
            content.append("## ðŸ› ï¸ Tecnologias Utilizadas")
            for category, techs in config['technologies'].items():
                if techs:
                    content.append(f"### {category.title()}")
                    for tech in techs:
                        content.append(f"- {tech}")
                    content.append("")
            
            # InstalaÃ§Ã£o
            content.append("## âš™ï¸ InstalaÃ§Ã£o e ConfiguraÃ§Ã£o")
            content.append("""
        ### Para Desenvolvedores:
        ```bash
        # Clone o repositÃ³rio
        git clone https://github.com/rclessa25-hub/imoveis-maceio.git
        cd imoveis-maceio
        
        # Estrutura pronta - nÃ£o requer build
        # Abra index.html no navegador ou use:
        
        # Servidor local Python
        python -m http.server 8000
        
        # Ou servidor Node.js
        npx serve .

        # Adicione esta nova seÃ§Ã£o sobre Supabase:
        if "supabase_config" in config:
            content.append("### ðŸ”— ConfiguraÃ§Ã£o do Supabase (JÃ CONECTADO)")
            content.append("""
        
   ```bash
   git clone https://github.com/rclessa25-hub/imoveis-maceio.git
   cd imoveis-maceio
    - name: ðŸ“Š Analisar estrutura modular
      run: |
        echo "## ðŸ“ ANÃLISE DA ESTRUTURA MODULAR" > structure-analysis.md
        echo "" >> structure-analysis.md
        
        # Contar arquivos por tipo
        echo "### ðŸ“ˆ EstatÃ­sticas de Arquivos" >> structure-analysis.md
        echo "" >> structure-analysis.md
        echo "- **Total HTML:** $(find . -name '*.html' -type f | wc -l)" >> structure-analysis.md
        echo "- **Total CSS:** $(find . -name '*.css' -type f | wc -l)" >> structure-analysis.md
        echo "- **Total JS:** $(find . -name '*.js' -type f | wc -l)" >> structure-analysis.md
        echo "- **Total Imagens:** $(find ./assets/images -type f 2>/dev/null | wc -l)" >> structure-analysis.md
        echo "" >> structure-analysis.md
        
        # Listar mÃ³dulos
        echo "### ðŸ§© MÃ³dulos JavaScript" >> structure-analysis.md
        echo "" >> structure-analysis.md
        for file in js/modules/*.js; do
          if [ -f "$file" ]; then
            filename=$(basename "$file")
            lines=$(wc -l < "$file")
            echo "- **${filename}:** $lines linhas" >> structure-analysis.md
          fi
        done
        echo "" >> structure-analysis.md
        
        # Listar componentes
        echo "### ðŸ§± Componentes" >> structure-analysis.md
        echo "" >> structure-analysis.md
        for file in js/components/*.js; do
          if [ -f "$file" ]; then
            filename=$(basename "$file" .js)
            echo "- **${filename}:** Componente reutilizÃ¡vel" >> structure-analysis.md
          fi
        done
        echo "" >> structure-analysis.md
        
        # Listar estilos
        echo "### ðŸŽ¨ Estilos CSS" >> structure-analysis.md
        echo "" >> structure-analysis.md
        for file in css/*.css; do
          if [ -f "$file" ]; then
            filename=$(basename "$file")
            lines=$(wc -l < "$file")
            echo "- **${filename}:** $lines linhas" >> structure-analysis.md
          fi
        done
        
        # Mover para reports
        mkdir -p reports
        mv structure-analysis.md reports/

        ```yaml
    - name: ðŸ”— Verificar conexÃ£o Supabase
      run: |
        echo "## ðŸ”— VERIFICAÃ‡ÃƒO SUPABASE" > supabase-status.md
        echo "" >> supabase-status.md
        
        # Verificar se hÃ¡ referÃªncias ao Supabase no cÃ³digo
        echo "### VerificaÃ§Ã£o no CÃ³digo" >> supabase-status.md
        echo "" >> supabase-status.md
        
        # Contar referÃªncias ao Supabase
        SUPABASE_REFS=$(grep -r "supabase" --include="*.js" --include="*.html" . | wc -l)
        echo "- **ReferÃªncias no cÃ³digo:** $SUPABASE_REFS" >> supabase-status.md
        
        # Verificar URL especÃ­fica
        if grep -q "syztbxvpdaplpetmixmt.supabase.co" index.html js/*.js 2>/dev/null; then
          echo "- **URL do projeto:** âœ… Encontrada" >> supabase-status.md
        else
          echo "- **URL do projeto:** âŒ NÃ£o encontrada" >> supabase-status.md
        fi
        
        # Verificar estrutura comum do Supabase
        echo "" >> supabase-status.md
        echo "### Estrutura Esperada" >> supabase-status.md
        echo "" >> supabase-status.md
        echo "- **Authentication:** Configurada para login de administradores" >> supabase-status.md
        echo "- **Database:** Tabelas: properties, users, images" >> supabase-status.md
        echo "- **Storage:** Bucket para imagens dos imÃ³veis" >> supabase-status.md
        echo "- **Row Level Security (RLS):** PolÃ­ticas para controle de acesso" >> supabase-status.md
        
        # Status final
        echo "" >> supabase-status.md
        echo "### ðŸ“Š Status da ConexÃ£o" >> supabase-status.md
        echo "" >> supabase-status.md
        echo "**ConclusÃ£o:** âœ… Projeto conectado ao Supabase" >> supabase-status.md
        echo "**AÃ§Ã£o necessÃ¡ria:** Nenhuma - conexÃ£o jÃ¡ estabelecida" >> supabase-status.md
        echo "**Acesso administrativo:** Via console Supabase com conta Google" >> supabase-status.md
        
        # Mover para reports
        mkdir -p reports
        cat supabase-status.md >> reports/structure-analysis.md
        
   ```bash
   git clone https://github.com/rclessa25-hub/imoveis-maceio.git
   cd imoveis-maceio
